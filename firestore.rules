/**
 * @file firestore.rules
 * @description Security rules for the CampusConnect Firestore database.
 *
 * @section Core Philosophy
 * This ruleset enforces a role-based security model centered around 'teachers' and 'students'.
 * Teachers have ownership and management rights over classes and their related content (assignments, attendance, notifications).
 * Students have read access to the classes they are enrolled in and write access only to their own private data, such as assignment submissions.
 *
 * @section Data Structure
 * - `/users/{userId}`: Contains private user profile data. Access is strictly limited to the user themselves.
 * - `/users/{userId}/submissions/{submissionId}`: A private subcollection for a student's own submissions.
 * - `/classes/{classId}`: A top-level collection for shared class data. This document is the source of truth for class membership and ownership.
 * - `/classes/{classId}/*`: Subcollections for class-specific content like assignments, attendance, and notifications. Access to these subcollections is derived from the user's role in the parent class document.
 *
 * @section Key Security Decisions
 * - User Enumeration Disabled: Listing users from the top-level `/users` collection is explicitly forbidden to protect user privacy.
 * - Teacher as Owner: The `teacherId` field on a `/classes/{classId}` document grants full administrative control over that class and all its subcollections.
 * - Student Membership: The `studentIds` array on a `/classes/{classId}` document grants read-only access to that class and its shared content.
 * - Private Submissions: Submissions are stored under the user's private data tree (`/users/{userId}/submissions`). This enforces strict ownership, meaning only the student can read or write their submissions. Teachers needing to view submissions would require a backend function or a change in data structure.
 *
 * @section Denormalization for Authorization
 * To ensure fast and secure rules, authorization data is denormalized directly onto the resource being protected.
 * - The `/classes/{classId}` document contains `teacherId` and `studentIds`. This avoids extra lookups for most class-related rules and makes security checks efficient.
 * - Subcollections under `/classes/{classId}` use `get()` on their parent document to determine access rights, a standard and secure pattern for inherited permissions.
 *
 * @section Structural Segregation
 * - Private student data (like submissions) is stored in a user-owned subcollection (`/users/{userId}/submissions`).
 * - Shared class data (like assignments) is stored in a separate, top-level collection (`/classes/{classId}/assignments`).
 * This separation provides a clear security boundary, preventing accidental data exposure and simplifying rules for list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is the owner of a document via path matching.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if a document exists before an update or delete operation.
    function docExists() {
      return resource != null;
    }

    // Checks if the requesting user is the teacher of the specified class.
    function isTeacherOfClass(classId) {
      return isSignedIn() && get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid;
    }

    // Checks if the requesting user is a student in the specified class.
    function isStudentInClass(classId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.studentIds;
    }

    // Checks if the user is either the teacher or an enrolled student of the class.
    function isMemberOfClass(classId) {
      return isTeacherOfClass(classId) || isStudentInClass(classId);
    }


    /**
     * @description Rules for user profile documents. Ensures users can only manage their own profile.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own user document for the first time.
     * @deny (get) A user attempting to read another user's profile information.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && docExists() && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && docExists();
    }

    /**
     * @description Rules for a student's private assignment submissions.
     * @path /users/{userId}/submissions/{submissionId}
     * @allow (create) A student submitting an assignment under their own user profile.
     * @deny (get) A teacher attempting to read a student's submission directly. This structure makes submissions private to the student.
     * @principle Enforces strict path-based ownership for private user-generated content.
     */
    match /users/{userId}/submissions/{submissionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.studentId == userId;
      allow update: if isOwner(userId) && docExists() && request.resource.data.studentId == resource.data.studentId;
      allow delete: if isOwner(userId) && docExists();
    }

    /**
     * @description Rules for class documents. Teachers have full control; students have read access.
     * @path /classes/{classId}
     * @allow (get) A student who is a member of the class reading the class details.
     * @deny (update) A student attempting to change the name of a class.
     * @principle Shared Access controlled by a single owner (`teacherId`) and multiple members (`studentIds`).
     */
    match /classes/{classId} {
      allow get: if isMemberOfClass(classId);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.teacherId == request.auth.uid;
      allow update: if isTeacherOfClass(classId) && docExists();
      allow delete: if isTeacherOfClass(classId) && docExists();

      /**
       * @description Rules for assignments within a class. Teachers can manage, members can read.
       * @path /classes/{classId}/assignments/{assignmentId}
       * @allow (create) A teacher creating a new assignment for a class they own.
       * @deny (delete) A student attempting to delete an assignment.
       * @principle Subcollection access permissions are inherited from the parent class document.
       */
      match /assignments/{assignmentId} {
        allow get: if isMemberOfClass(classId);
        allow list: if isMemberOfClass(classId);
        allow create: if isTeacherOfClass(classId);
        allow update: if isTeacherOfClass(classId) && docExists();
        allow delete: if isTeacherOfClass(classId) && docExists();
      }

      /**
       * @description Rules for attendance records. Teachers manage all; students can read their own.
       * @path /classes/{classId}/attendance/{attendanceId}
       * @allow (get) A student reading their own attendance record for a class.
       * @deny (list) A student listing all attendance records for a class to protect other students' privacy.
       * @principle Granular read access within a subcollection based on document content.
       */
      match /attendance/{attendanceId} {
        allow get: if isTeacherOfClass(classId) || (isStudentInClass(classId) && resource.data.studentId == request.auth.uid);
        allow list: if isTeacherOfClass(classId);
        allow create: if isTeacherOfClass(classId);
        allow update: if isTeacherOfClass(classId) && docExists();
        allow delete: if isTeacherOfClass(classId) && docExists();
      }

      /**
       * @description Rules for class notifications. Teachers can manage, members can read.
       * @path /classes/{classId}/notifications/{notificationId}
       * @allow (list) Any class member (teacher or student) listing the notifications for that class.
       * @deny (create) A student attempting to send a notification to the class.
       * @principle Subcollection access permissions are inherited from the parent class document.
       */
      match /notifications/{notificationId} {
        allow get: if isMemberOfClass(classId);
        allow list: if isMemberOfClass(classId);
        allow create: if isTeacherOfClass(classId);
        allow update: if isTeacherOfClass(classId) && docExists();
        allow delete: if isTeacherOfClass(classId) && docExists();
      }
    }
  }
}